version: '3.8'

services:
  # Laravel App (PHP-FPM)
  app:
    build: ./backend/codebranch-api
    container_name: codebranch-backend
    restart: always
    env_file: ./backend/codebranch-api/.env
    networks:
      - backend-network

  # Nginx for Laravel (API)
  nginx-api:
    image: nginx:alpine
    container_name: codebranch-api
    volumes:
      - ./backend/codebranch-api:/var/www 
      - ./nginx/conf.d:/etc/nginx/conf.d
    networks:
      - backend-network

  # Vue Frontend + Path Proxy
  frontend:
    build: ./frontend
    container_name: codebranch-ui
    networks:
      - web             # Connect to the shared Traefik network
      - backend-network # Connect to the internal Laravel network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.codebranch.rule=Host(`codebranch.me`)"
      - "traefik.http.routers.codebranch.entrypoints=websecure"
      - "traefik.http.routers.codebranch.tls=true" # Add this based on your Homer config
      - "traefik.http.routers.codebranch.tls.certresolver=myresolver"
      - "traefik.http.services.codebranch.loadbalancer.server.port=80"

  db:
    image: mysql:8.0
    container_name: codebranch-db
    env_file: ./backend/codebranch-api/.env
    networks:
      - backend-network

networks:
  # Change this from traefik-public to web to match Homer
  web:
    external: true
  backend-network:
    driver: bridge